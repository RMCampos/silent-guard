---

services:
  silent-web:
    container_name: silent-web
    depends_on:
      silent-api:
        condition: service_healthy
    image: ghcr.io/rmcampos/silent-guard/silent-web:candidate
    build:
      context: silent-app
      dockerfile: Dockerfile
    ports: ["5173:5173"]
    environment:
      VITE_BACKEND_SERVER: https://silentguard-local.ricardocampos.dev.br:8443
      VITE_BUILD: nightly

  silent-api:
    container_name: silent-api
    depends_on:
      silent-db:
        condition: service_healthy
    environment:
      POSTGRES_DB: sg
      POSTGRES_HOST: silent-db
      POSTGRES_USER: sg
      POSTGRES_PASSWORD: default
      POSTGRES_PORT: 5432
      CORS_ALLOWED_ORIGINS: https://silentguard-local.ricardocampos.dev.br:5173
      SERVER_SERVLET_CONTEXT_PATH: /
      TARGET_ENV: development
      API_LOGGING_LEVEL: INFO
      SPRING_PROFILES_ACTIVE: dev
    ports: ["8443:8443"]
    image: ghcr.io/rmcampos/silent-guard/silent-api:candidate
    build:
      context: silent-api
      dockerfile: Dockerfile.dev

  silent-db:
    container_name: silent-db
    image: postgres:15.8-bookworm
    environment:
      POSTGRES_DB: sg
      POSTGRES_USER: sg
      POSTGRES_PASSWORD: default
    ports: ["5432:5432"]
    healthcheck:
      test: psql -q -U $${POSTGRES_USER} -d $${POSTGRES_DB} -c 'SELECT 1'
      interval: 1m30s
      timeout: 15s
      retries: 3
      start_period: 10s
